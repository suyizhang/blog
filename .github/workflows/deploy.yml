name: éƒ¨ç½²åˆ°ä¸ªäººæœåŠ¡å™¨

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ä¸ªäººæœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # æž„å»ºå‰ç«¯
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: è¿è¡Œå‰ç«¯æµ‹è¯•
        run: npm run test:ci --if-present

      - name: æž„å»ºå‰ç«¯
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_GITHUB_CLIENT_ID: ${{ secrets.VITE_GITHUB_CLIENT_ID }}

      # æž„å»ºåŽç«¯
      - name: å®‰è£…åŽç«¯ä¾èµ–
        run: |
          cd backend
          npm ci

      - name: è¿è¡ŒåŽç«¯æµ‹è¯•
        run: |
          cd backend
          npm run test --if-present

      - name: æž„å»ºåŽç«¯
        run: |
          cd backend
          npm run build

      # éƒ¨ç½²åˆ°ä¸ªäººæœåŠ¡å™¨
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è®¾ç½®éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="/var/www/personal-website"
            BACKUP_DIR="/var/backups/personal-website-$(date +%Y%m%d-%H%M%S)"
            
            # åˆ›å»ºå¤‡ä»½
            if [ -d "$DEPLOY_DIR" ]; then
              echo "åˆ›å»ºå¤‡ä»½åˆ° $BACKUP_DIR"
              sudo cp -r $DEPLOY_DIR $BACKUP_DIR
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            if [ -d ".git" ]; then
              echo "æ›´æ–°çŽ°æœ‰ä»“åº“"
              sudo git fetch origin
              sudo git reset --hard origin/main
            else
              echo "å…‹éš†æ–°ä»“åº“"
              sudo git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # å®‰è£…ä¾èµ–å¹¶æž„å»º
            echo "å®‰è£…å‰ç«¯ä¾èµ–"
            sudo npm ci
            
            echo "æž„å»ºå‰ç«¯"
            sudo npm run build
            
            echo "å®‰è£…åŽç«¯ä¾èµ–"
            cd backend
            sudo npm ci
            
            echo "æž„å»ºåŽç«¯"
            sudo npm run build
            
            # è®¾ç½®çŽ¯å¢ƒå˜é‡
            echo "è®¾ç½®çŽ¯å¢ƒå˜é‡"
            sudo tee .env > /dev/null <<EOF
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
            GITHUB_CLIENT_ID="${{ secrets.GITHUB_CLIENT_ID }}"
            GITHUB_CLIENT_SECRET="${{ secrets.GITHUB_CLIENT_SECRET }}"
            GITHUB_CALLBACK_URL="${{ secrets.GITHUB_CALLBACK_URL }}"
            PORT=5001
            NODE_ENV=production
            FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
            EOF
            
            # æ•°æ®åº“è¿ç§»
            echo "è¿è¡Œæ•°æ®åº“è¿ç§»"
            sudo npx prisma generate
            sudo npx prisma db push
            
            # é‡å¯æœåŠ¡
            echo "é‡å¯åº”ç”¨æœåŠ¡"
            sudo systemctl restart personal-website-backend || echo "åŽç«¯æœåŠ¡é‡å¯å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®"
            sudo systemctl restart nginx || echo "Nginxé‡å¯å¤±è´¥"
            
            echo "éƒ¨ç½²å®Œæˆï¼"

      # å¥åº·æ£€æŸ¥
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥åŽç«¯API
          if curl -f ${{ secrets.VITE_API_URL }}/health; then
            echo "âœ… åŽç«¯APIå¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ åŽç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥å‰ç«¯
          if curl -f ${{ secrets.FRONTEND_URL }}; then
            echo "âœ… å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      # å‘é€é€šçŸ¥
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "å‰ç«¯åœ°å€: ${{ secrets.FRONTEND_URL }}"
            echo "åŽç«¯API: ${{ secrets.VITE_API_URL }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
